name: CI/CD - Build, Test, Push & Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build with Maven
        run: ./mvnw -B clean verify

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: docker build -t ghcr.io/ozonebox/laundryheroes-core:latest .

      - name: Push Docker image
        run: docker push ghcr.io/ozonebox/laundryheroes-core:latest

      - name: Test Docker image runs
        run: |
          docker run --rm -d \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=ci \
            --name app \
            ghcr.io/ozonebox/laundryheroes-core:latest

          echo "Waiting for the app to boot..."
          sleep 20

          curl -f http://localhost:8080/api/ping

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Add EC2 SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy to EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "Pulling latest image..."
            docker pull ghcr.io/ozonebox/laundryheroes-core:latest

            echo "Stopping old container..."
            docker stop laundryheroes-app || true
            docker rm laundryheroes-app || true

            echo "Starting new container..."
            cd ~/laundryheroes-core
            docker compose down
            docker compose up -d

            docker ps
          EOF

